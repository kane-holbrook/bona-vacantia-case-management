<template>
    <template for:each={sectionsMain} for:item="section">
        <div class="slds-box" key={section.heading}>
            <article class="slds-card database-card">
                <div class="slds-card__header slds-grid slds-align_absolute-center" style="padding: 1em;">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__figure">
                            <span class="slds-icon_container slds-icon-standard-account" title={section.heading}>
                                <lightning-icon icon-name="standard:account" alternative-text={section.heading} size="small"></lightning-icon>
                            </span>
                        </div>
                        <div class="slds-media__body">
                            <div class="slds-card__header-subtitle">
                                <span>{cardSubtitle}</span>
                            </div>
                            <h2 class="slds-card__header-title">
                                <a href="#" class="slds-card__header-link slds-truncate" title={section.heading}>
                                    <span>{section.heading}</span>
                                </a>
                            </h2>
                        </div>
                        <div class="slds-media__figure slds-media__figure_reverse">
                            <template if:true={isBVCase}>
                                <!-- <template if:true={hasData}>
                                    <button class="slds-button slds-button_brand" onclick={openModal}>
                                        <lightning-icon icon-name="utility:add" alternative-text="Add" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                        Edit
                                    </button>
                                </template> -->
                                <template if:false={hasData}>
                                    <button class="slds-button slds-button_brand" onclick={openModal}>
                                        <lightning-icon icon-name="utility:add" alternative-text="Add" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                        Add
                                    </button>
                                </template>
                            </template>
                            <template if:false={isBVCase}>
                                <template if:false={isEdgeCase}>
                                    <button class="slds-button slds-button_brand" onclick={openModal}>
                                        <lightning-icon icon-name="utility:add" alternative-text="Add" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                        Add
                                    </button>
                                </template>
                            </template>
                        </div>                        
                    </header>
                </div>
                <div class="slds-card__body">
                    <template if:true={hasData}>
                        <table aria-multiselectable="true" class="slds-table slds-table_bordered slds-table_fixed-layout slds-table_resizable-cols" role="grid" aria-label="Example advanced table of Opportunities in actionable mode">
                            <thead>
                                <tr class="slds-line-height_reset">
                                    <th style="width: 3.25rem;"></th>
                                    <template for:each={columnsMain} for:item="column">
                                        <th aria-sort="none" class="slds-is-resizable slds-is-sortable slds-cell_action-mode" scope="col" key={column.apiName} onclick={onHandleSort} data-field={column.fieldName}>
                                            <a class="slds-th__action slds-text-link_reset" href="#" role="button" tabindex="0">
                                                <span class="slds-assistive-text">Sort by: </span>
                                                <div class="slds-grid slds-grid_vertical-align-center slds-has-flexi-truncate">
                                                    <span class="slds-truncate" title={column.label}>{column.label}</span>
                                                    <span class="slds-icon_container slds-icon-utility-arrowdown">
                                                        <svg class="slds-icon slds-icon-text-default slds-is-sortable__icon " aria-hidden="true">
                                                            <use xlink:href="/assets/icons/utility-sprite/svg/symbols.svg#down"></use>
                                                        </svg>
                                                    </span>
                                                </div>
                                            </a>
                                            <div class="slds-resizable">
                                                <input type="range" aria-label="Account Name column width" class="slds-resizable__input slds-assistive-text" max="1000" min="20" tabindex="0" />
                                                <span class="slds-resizable__handle">
                                                    <span class="slds-resizable__divider"></span>
                                                </span>
                                            </div>
                                        </th>
                                    </template>
                                    <th style="width: 3.25rem;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={tableDataObj} for:item="row">
                                    <tr aria-selected="false" class="slds-hint-parent" key={row.Id}>
                                        <td class="slds-cell_action-mode" role="gridcell">
                                            <div class="slds-truncate">
                                                <template if:true={expandedView}>
                                                    <button class="slds-button slds-button_icon slds-m-right_x-small" aria-hidden="true" tabindex="-1" data-targetrow={row.Id} onclick={expandSection}>
                                                        <lightning-icon icon-name="utility:chevronright" alternative-text="Expand" size="x-small"></lightning-icon>
                                                    </button>
                                                </template>
                                            </div>
                                        </td>
                                        <template for:each={row.Cells} for:item="cell" for:index="index">
                                            <td class="slds-cell_action-mode" role="gridcell" key={cell.Id}>
                                                <div class="slds-truncate" title={cell.value}>{cell.value}</div>
                                            </td>
                                        </template>
                                        <td class="slds-cell_action-mode" role="gridcell">
                                            <div class="lgc-bg">
                                                <lightning-button-menu icon-size="small" menu-alignment="right" alternative-text="Show menu" data-row={row.Id} onselect={handleRowAction}>
                                                    <lightning-menu-item value="edit" label="Edit"></lightning-menu-item>
                                                    <lightning-menu-item value="delete" label="Delete"></lightning-menu-item>
                                                </lightning-button-menu>
                                            </div>
                                        </td>
                                    </tr>
                                    <div class="slds-p-around_x-small expanded-section" key={row.Id} data-rowid={row.Id} style="display:none;">
                                        <template for:each={row.fullData} for:item="dataRow">
                                            <dl class="slds-dl_horizontal" key={dataRow.Id} style="row-gap: 8px;">
                                                <template for:each={dataRow.fields} for:item="field">
                                                    <dt class="slds-dl_horizontal__label" key={field.fieldName} title={field.label} style="font-weight: bold;">{field.label}</dt>
                                                    <dd class="slds-dl_horizontal__detail" key={field.fieldName} title={field.value}>{field.value}</dd>
                                                </template>
                                            </dl>
                                        </template>
                                    </div>
                                </template>
                            </tbody>
                        </table>

                    </template>
                    <template if:false={hasData}>
                        <!-- <p>There are no {section.heading} associated with this case.</p> -->
                        <p>There are no records of this type associated with this case</p>
                    </template>
                </div>
            </article>
        </div>
    </template>

    <template if:true={isModalOpen}>
        <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <!-- Modal Header -->
                <header class="slds-modal__header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeModal}>
                        <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <template if:true={isBVCase}>
                        <template if:true={hasData}>
                            <h2 class="slds-text-heading_medium">{editModalHeading}</h2>
                        </template>
                        <template if:false={hasData}>
                            <h2 class="slds-text-heading_medium">{modalHeading}</h2>
                        </template>
                    </template>
                    <template if:false={isBVCase}>
                        <template if:true={hasData}>
                            <h2 class="slds-text-heading_medium">{editModalHeading}</h2>
                        </template>
                        <template if:false={hasData}>
                            <h2 class="slds-text-heading_medium">{modalHeading}</h2>
                        </template>
                    </template>
                </header>
                <div class="slds-modal__content slds-p-around_medium">
                    <c-database-standard-record-modal
                        record-id={recordId}
                        object-api-name={objectApiName}
                        record-type-id={recordTypeId}
                        record-data={recordData}
                        sub-record-id={subRecordId}
                        column-layout-style={columnLayoutStyle}
                        columns={columns}
                        oncancelupdate={handleCancelUpdate}
                        onrecordupdated={handleRecordUpdated}>
                    </c-database-standard-record-modal>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <template if:true={isModalOpenDelete}>
        <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <!-- Modal Header -->
                <header class="slds-modal__header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeModalDelete}>
                        <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 class="slds-text-heading_medium">{deleteModalHeading}</h2>
                </header>
    
                <!-- Modal Body -->
                <div class="slds-modal__content slds-p-around_medium">
                    <c-database-standard-record-modal-delete 
                        record-id={recordId}
                        object-api-name={objectApiName}
                        record-data={recordData}
                        columns={columns}
                        sub-record-id={subRecordId}
                        oncanceldelete={handleCancelUpdate}
                        onrecorddeleted={handleRecordDeleted}>
                    </c-database-standard-record-modal-delete>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>