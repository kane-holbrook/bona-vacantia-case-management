<template>
    <!-- First Card for Task Header and Actions -->
    <article class="slds-card slds-m-around_medium task-card">
        <div class="slds-card__header slds-grid">
            <header class="slds-media slds-media_center slds-has-flexi-truncate">
                <div class="slds-media__figure">
                    <lightning-icon icon-name="standard:task" size="medium"></lightning-icon>
                </div>
                <div class="slds-media__body">
                    <div class="slds-card__header-subtitle">
                        <span>Tasks</span>
                    </div>
                    <h2 class="slds-card__header-title">
                        <a href="javascript:void(0);" class="slds-card__header-link slds-truncate" title={taskName}>
                            <span class="slds-text-heading_medium">{taskName}</span>
                        </a>
                    </h2>
                </div>
                <div class="slds-no-flex">
                    <div class="button-group slds-text-align_right">
                        <lightning-button variant="neutral" label="Mark task as complete" onclick={onCompleteTask} disabled={hasSubTasks}></lightning-button>
                        <lightning-button variant="neutral" label="Create a sub-task" data-id={parentTaskId} onclick={onEditSubTask}></lightning-button>
                        <lightning-button-menu alternative-text="Show More">
                            <lightning-menu-item label="Edit Task" data-id={recordId} onclick={onEditTask}></lightning-menu-item>
                            <lightning-menu-item label="Delete" data-id={recordId} onclick={onDeleteTask}></lightning-menu-item>
                        </lightning-button-menu>
                    </div>
                </div>
            </header>
        </div>
    </article>

    <!-- Second Card for Details and Tabs -->
    <article class="slds-card slds-m-around_medium details-card">
        <div class="slds-box no-box-borders">
            <div class="slds-card__body">
                <lightning-tabset>
                    <lightning-tab label="Details" name="details">
                        <div class="slds-grid slds-wrap">
                            <div class="slds-col slds-size_1-of-2">
                                <p class="detail-item"><strong>Parent task:</strong> {parentTask}</p>
                                <p class="detail-item"><strong>Assigned to:</strong> {assignedToName}</p>
                                <p class="detail-item"><strong>Due date:</strong> <lightning-formatted-date-time value={dueDate} day="numeric" month="numeric" year="numeric"></lightning-formatted-date-time></p>
                                <p class="detail-item"><strong>Priority:</strong>
                                    <template if:true={isCritical}>
                                        <lightning-icon icon-name="utility:info" alternative-text="Critical" size="small" class="critical-icon slds-m-right_x-small"></lightning-icon>
                                    </template>
                                    <template if:true={isHigh}>
                                        <lightning-icon icon-name="utility:info_alt" alternative-text="High" size="small" class="high-icon slds-m-right_x-small"></lightning-icon>
                                    </template>
                                    {priority}
                                </p>                                
                                <p class="detail-item"><strong>Comments:</strong> {comments}</p>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <p class="detail-item"><strong>Created by:</strong> {createdByName}</p>
                                <p class="detail-item"><strong>Last modified by:</strong> {lastModifiedByName}</p>
                                <p class="detail-item"><strong>Next task:</strong> {nextTask}</p>
                            </div>
                        </div>

                        <div class="slds-section slds-m-vertical_large" style="border-top: 2px solid #c9c9c9;"></div>
                        <ul class="slds-accordion">
                            <template for:each={subTasks} for:item="subTask">
                                <li key={subTask.Id} class="slds-accordion__list-item">
                                    <section class={subTask.sectionClass}>
                                        <div class="slds-accordion__summary">
                                            <h2 class="slds-accordion__summary-heading">
                                                <button class="slds-button slds-button_reset slds-accordion__summary-action" aria-controls={subTask.Id} aria-expanded={subTask.isOpen} title="Accordion summary" data-id={subTask.Id} onclick={toggleSubTask}>
                                                    <lightning-icon icon-name={subTask.iconName} size="x-small" alternative-text="Accordion summary" class="slds-accordion__summary-action-img"></lightning-icon>
                                                    <lightning-icon icon-name="standard:task" size="x-small" alternative-text="Task icon" class="slds-accordion__summary-action-img slds-m-around_small"></lightning-icon>
                                                    <span class="slds-accordion__summary-content">{subTask.Name}</span>
                                                </button>
                                            </h2>
                                            <div class="slds-dropdown-trigger slds-dropdown-trigger_click">
                                                <lightning-button-menu alternative-text="Show More" menu-alignment="right">
                                                    <lightning-menu-item label="Edit Subtask" data-id={subTask.Id} onclick={onEditSubTask}></lightning-menu-item>
                                                    <lightning-menu-item label="Delete" data-id={subTask.Id} onclick={onDeleteTask}></lightning-menu-item>
                                                </lightning-button-menu>
                                            </div>
                                        </div>
                                        <div class="slds-accordion__content accordion-content-margin" id={subTask.Id}>
                                            <!-- General Section -->
                                            <div class="slds-section">
                                                <h3 class="slds-section__title">General</h3>
                                                <p><strong>Description of task:</strong> {subTask.Name}</p>
                                                <p><strong>Comments:</strong> {subTask.Comments}</p>
                                                <p><strong>Case officer:</strong> {subTask.Assigned_To_Name}</p>
                                                <p><strong>Priority:</strong> {subTask.Priority__c}</p>
                                            </div>
                                            <!-- Waiting Period Section -->
                                            <div class="slds-section">
                                                <h3 class="slds-section__title">Waiting period</h3>
                                                <p><strong>Waiting period:</strong> {subTask.Waiting_Period__c}</p>
                                                <p><strong>Date inserted:</strong> {subTask.formattedDateInserted}</p>
                                                <p><strong>Due:</strong> {subTask.formattedDueDate}</p>
                                            </div>
                                            <!-- Action Section -->
                                            <div class="slds-section">
                                                <h3 class="slds-section__title">Action</h3>
                                                <p><strong>Document:</strong> {subTask.Document__c}</p>
                                            </div>
                                        </div>
                                    </section>
                                </li>
                            </template>
                        </ul>
                    </lightning-tab>
                    <lightning-tab label="Templates" name="templates">
                        <template if:true={hasTemplates}>
                            <lightning-combobox
                                name="templateSelect"
                                label="Select Template"
                                value={selectedTemplate}
                                placeholder="Choose Template"
                                options={templates}
                                onchange={handleTemplateChange}>
                            </lightning-combobox>
                            <lightning-button
                                label="Proceed to Generate"
                                onclick={handleProceedToGenerate}
                                class="slds-m-top_medium"
                                variant="brand"
                                disabled={isProceedButtonDisabled}>
                            </lightning-button>
                        </template>
                        <template if:false={hasTemplates}>
                            <p>No templates available</p>
                        </template>
                    </lightning-tab>
                </lightning-tabset>
            </div>
        </div>
    </article>

    <template if:true={isPdftronOpen}>
        <c-pdftron-wv-instance-flow selected-document-id={selectedTemplate} onclose={handlePdftronClose}></c-pdftron-wv-instance-flow>
    </template>

    <template if:true={editSubTask}>
        <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <!-- Modal Header -->
                <header class="slds-modal__header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={onEditTaskClose}>
                        <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 class="slds-text-heading_medium">{modalHeader}</h2>
                </header>
                <div class="slds-modal__content slds-p-around_medium">
                    <c-task-manage-modal record-id={currentSubTaskId} parent-task-id={parentTaskId} ontaskcreated={handleSaveSuccess} ontaskupdated={handleSaveSuccess}></c-task-manage-modal>
                </div>
                <footer class="slds-modal__footer">
                    <button class="slds-button slds-button_neutral" onclick={onEditTaskClose}>Cancel</button>
                    <button class="slds-button slds-button_brand" onclick={handleSave}>Confirm</button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <template if:true={deleteTask}>
        <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <!-- Modal Header -->
                <header class="slds-modal__header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={onDeleteTaskClose}>
                        <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 class="slds-text-heading_medium">Are you sure you want to delete this task?</h2>
                </header>
                <div class="slds-modal__content slds-p-around_medium">
                    <c-task-delete-modal record-id={currentSubTaskId} onclose={onDeleteTaskClose} ontaskdeleted={handleDeleteSuccess}></c-task-delete-modal>
                </div>
                <footer class="slds-modal__footer">
                    <button class="slds-button slds-button_neutral" onclick={onDeleteTaskClose}>Cancel</button>
                    <button class="slds-button slds-button_destructive" onclick={handleDelete}>Yes - delete</button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <template if:true={completeTask}>
        <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <!-- Modal Header -->
                <header class="slds-modal__header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={onCompleteTaskClose}>
                        <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 class="slds-text-heading_medium">Are you sure you want to mark this task complete?</h2>
                </header>
                <div class="slds-modal__content slds-p-around_medium">
                    <c-task-mark-as-complete-modal
                        record-id={recordId}
                        task-name={taskName}
                        parent-task={parentTask}
                        assigned-to={assignedTo}
                        due-date={dueDate}
                        priority={priority}
                        comments={comments}
                        created-by={createdBy}
                        last-modified-by={lastModifiedBy}
                        next-task={nextTask}
                        onclose={onCompleteTaskClose}
                        ontaskdeletecomplete={handleDeleteSuccess}>
                    </c-task-mark-as-complete-modal>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>